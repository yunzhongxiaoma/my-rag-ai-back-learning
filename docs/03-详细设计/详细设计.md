# è¯¦ç»†è®¾è®¡æ–‡æ¡£

## 1. æ¥å£è®¾è®¡

### 1.1 ç”¨æˆ·ç®¡ç†æ¥å£

#### 1.1.1 ç”¨æˆ·æ³¨å†Œæ¥å£
```http
POST /api/v1/user/register
Content-Type: application/json

Request Body:
{
    "username": "string",
    "password": "string", 
    "email": "string",
    "nickname": "string"
}

Response:
{
    "code": 200,
    "message": "æ³¨å†ŒæˆåŠŸ",
    "data": {
        "userId": "long",
        "username": "string",
        "nickname": "string",
        "createTime": "datetime"
    }
}
```

#### 1.1.2 ç”¨æˆ·ç™»å½•æ¥å£
```http
POST /api/v1/user/login
Content-Type: application/x-www-form-urlencoded

Request Parameters:
- userName: string (default: "admin")
- password: string

Response:
{
    "code": 200,
    "message": "ç™»å½•æˆåŠŸ",
    "data": {
        "token": "string",
        "userInfo": {
            "userId": "long",
            "username": "string",
            "nickname": "string",
            "role": "string"
        }
    }
}
```

#### 1.1.3 ç”¨æˆ·é€€å‡ºæ¥å£
```http
POST /api/v1/user/logout
Authorization: Bearer {token}

Response:
{
    "code": 200,
    "message": "é€€å‡ºæˆåŠŸ",
    "data": null
}
```

#### 1.1.4 ä¿®æ”¹å¯†ç æ¥å£
```http
POST /api/v1/user/updatePassword
Content-Type: application/json
Authorization: Bearer {token}

Request Body:
{
    "oldPassword": "string",
    "newPassword": "string"
}

Response:
{
    "code": 200,
    "message": "å¯†ç ä¿®æ”¹æˆåŠŸ",
    "data": null
}
```

### 1.2 çŸ¥è¯†åº“ç®¡ç†æ¥å£

#### 1.2.1 æ–‡æ¡£ä¸Šä¼ æ¥å£
```http
POST /api/v1/knowledge/file/upload
Content-Type: multipart/form-data
Authorization: Bearer {token}

Request Body:
- file: MultipartFile[] (æ”¯æŒå¤šæ–‡ä»¶ä¸Šä¼ )

Response:
{
    "code": 200,
    "message": "ä¸Šä¼ æˆåŠŸ",
    "data": {
        "documentId": "long",
        "fileName": "string",
        "fileSize": "long",
        "uploadTime": "datetime",
        "status": "PROCESSING"
    }
}
```

#### 1.2.2 æ–‡æ¡£åˆ—è¡¨æŸ¥è¯¢æ¥å£
```http
GET /api/v1/knowledge/contents
Authorization: Bearer {token}

Query Parameters:
- page: int (default: 1)
- pageSize: int (default: 10)
- keyword: string (optional)

Response:
{
    "code": 200,
    "message": "æŸ¥è¯¢æˆåŠŸ",
    "data": {
        "total": "long",
        "pages": "int",
        "current": "int",
        "records": [
            {
                "id": "long",
                "fileName": "string",
                "url": "string",
                "vectorId": "string",
                "createTime": "datetime",
                "updateTime": "datetime"
            }
        ]
    }
}
```

#### 1.2.3 æ–‡æ¡£ä¸‹è½½æ¥å£
```http
GET /api/v1/knowledge/download
Authorization: Bearer {token}

Query Parameters:
- ids: List<Long> (æ–‡æ¡£IDåˆ—è¡¨)

Response:
{
    "code": 200,
    "message": "ä¸‹è½½æˆåŠŸ",
    "data": {
        "downloadUrl": "string"
    }
}
```

### 1.3 æ™ºèƒ½é—®ç­”æ¥å£

#### 1.3.1 RAGå¯¹è¯æ¥å£
```http
GET /api/v1/ai/rag
Authorization: Bearer {token}

Query Parameters:
- message: string (default: "ä½ å¥½")

Response: Server-Sent Events (text/event-stream)
- æµå¼è¿”å›AIç”Ÿæˆçš„å›ç­”å†…å®¹
```

#### 1.3.2 æµå¼å¯¹è¯æ¥å£
```http
GET /api/v1/chat/stream
Authorization: Bearer {token}

Query Parameters:
- message: string (default: "ä½ å¥½")

Response: Server-Sent Events (text/event-stream)
- æµå¼è¿”å›å¯¹è¯å†…å®¹
```

#### 1.3.3 å¯¹è¯å†å²æŸ¥è¯¢æ¥å£ï¼ˆæš‚æœªå®ç°ï¼‰
```http
GET /api/v1/chat/history
Authorization: Bearer {token}

Query Parameters:
- sessionId: string
- page: int (default: 1)
- size: int (default: 20)

Response:
{
    "code": 200,
    "message": "æŸ¥è¯¢æˆåŠŸ",
    "data": {
        "sessionId": "string",
        "messages": [
            {
                "messageId": "long",
                "type": "USER|ASSISTANT",
                "content": "string",
                "timestamp": "datetime"
            }
        ]
    }
}
```

### 1.4 å‘é‡ç®¡ç†æ¥å£ï¼ˆæš‚æœªå®ç°ï¼‰

#### 1.4.1 å‘é‡æ£€ç´¢æ¥å£ï¼ˆæš‚æœªå®ç°ï¼‰
```http
POST /api/v1/vector/search
Content-Type: application/json
Authorization: Bearer {token}

Request Body:
{
    "query": "string",
    "topK": "int" (default: 10),
    "threshold": "double" (default: 0.7),
    "documentIds": ["long"] (optional)
}

Response:
{
    "code": 200,
    "message": "æ£€ç´¢æˆåŠŸ",
    "data": {
        "results": [
            {
                "documentId": "long",
                "content": "string",
                "similarity": "double",
                "metadata": "object"
            }
        ],
        "searchTime": "long"
    }
}
```

### 1.5 ç³»ç»Ÿç®¡ç†æ¥å£

#### 1.5.1 æ•æ„Ÿè¯ç®¡ç†æ¥å£
```http
# æ–°å¢æ•æ„Ÿè¯
POST /api/v1/sensitive/add
Content-Type: application/json
Authorization: Bearer {token}

Request Body:
{
    "word": "string",
    "category": "string",
    "status": "string"
}

# åˆ†é¡µæŸ¥è¯¢æ•æ„Ÿè¯
GET /api/v1/sensitive/page
Authorization: Bearer {token}

Query Parameters:
- page: int
- size: int

# æ‰¹é‡åˆ é™¤æ•æ„Ÿè¯
POST /api/v1/sensitive/batch
Content-Type: application/json
Authorization: Bearer {token}

Request Body: [1, 2, 3] (æ•æ„Ÿè¯IDæ•°ç»„)
```

#### 1.5.2 æ•æ„Ÿè¯åˆ†ç±»ç®¡ç†æ¥å£
```http
# æ–°å¢æ•æ„Ÿè¯åˆ†ç±»
POST /api/v1/category/add
Content-Type: application/json
Authorization: Bearer {token}

Request Body:
{
    "categoryName": "string",
    "status": "string"
}

# åˆ†é¡µæŸ¥è¯¢åˆ†ç±»
GET /api/v1/category/page
Authorization: Bearer {token}

Query Parameters:
- page: int (default: 1)
- size: int (default: 10)

# è·å–å…¨éƒ¨åˆ†ç±»åˆ—è¡¨
GET /api/v1/category/list
Authorization: Bearer {token}
```

#### 1.5.3 æ—¥å¿—ç®¡ç†æ¥å£
```http
# åˆ†é¡µæŸ¥è¯¢æ—¥å¿—
GET /api/v1/log/page
Authorization: Bearer {token}

Query Parameters:
- page: int
- size: int
- methodName: string (optional)
- className: string (optional)
- startTime: datetime (optional)
- endTime: datetime (optional)

# æ‰¹é‡åˆ é™¤æ—¥å¿—
POST /api/v1/log/batch
Authorization: Bearer {token}
```

#### 1.5.4 è¯é¢‘ç»Ÿè®¡æ¥å£
```http
# åˆ†é¡µæŸ¥è¯¢è¯é¢‘
POST /api/v1/frequency/page
Content-Type: application/json
Authorization: Bearer {token}

Request Body:
{
    "page": "int",
    "pageSize": "int",
    "word": "string" (optional),
    "businessType": "string" (optional)
}

# è·å–è¯é¢‘åˆ—è¡¨
GET /api/v1/frequency/getList
Authorization: Bearer {token}
```

#### 1.5.5 æµ‹è¯•æ¥å£
```http
# è¿é€šæ€§æµ‹è¯•
GET /api/v1/test/ping

# CORSæµ‹è¯•
GET/POST/OPTIONS /api/v1/test/cors

# å¥åº·æ£€æŸ¥
GET /api/v1/test/health
```

#### 1.5.6 AIç»˜å›¾æ¥å£
```http
GET /api/v1/draw/image
Authorization: Bearer {token}

Query Parameters:
- prompt: string (ç»˜å›¾æç¤ºè¯)

Response: ç›´æ¥è¿”å›å›¾ç‰‡æµ
```

## 2. æ•°æ®åº“è¡¨ç»“æ„è®¾è®¡

### 2.1 ç”¨æˆ·ç›¸å…³è¡¨

#### 2.1.1 ç”¨æˆ·è¡¨ (tb_user)
```sql
CREATE TABLE `tb_user` (
    `id` INT NOT NULL AUTO_INCREMENT,
    `name` VARCHAR(255) NOT NULL COMMENT 'å§“å',
    `user_name` VARCHAR(255) NOT NULL COMMENT 'ç”¨æˆ·å',
    `password` VARCHAR(255) NOT NULL COMMENT 'å¯†ç ',
    `phone` VARCHAR(255) NOT NULL COMMENT 'æ‰‹æœºå·',
    `sex` VARCHAR(255) NOT NULL COMMENT 'æ€§åˆ«',
    `id_number` VARCHAR(255) NOT NULL COMMENT 'èº«ä»½è¯å·',
    `status` INT NOT NULL DEFAULT 1 COMMENT 'çŠ¶æ€ 0ï¼šç¦ç”¨ 1ï¼šå¯ç”¨',
    `create_time` DATE COMMENT 'åˆ›å»ºæ—¶é—´',
    `update_time` DATE COMMENT 'æ›´æ–°æ—¶é—´',
    `create_user` BIGINT COMMENT 'åˆ›å»ºäºº',
    `update_user` BIGINT COMMENT 'ä¿®æ”¹äºº',
    PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=666498 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='ç”¨æˆ·è¡¨';
```

### 2.2 å‘é‡å­˜å‚¨ç›¸å…³è¡¨

#### 2.2.1 å‘é‡å­˜å‚¨è¡¨ (vector_store)
```sql
CREATE TABLE `vector_store` (
    `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®ID',
    `content` TEXT,
    `metadata` JSON,
    `embedding` JSON COMMENT 'å‘é‡æ•°æ®ï¼Œå­˜å‚¨ä¸ºJSONæ•°ç»„ï¼ŒåŸPostgreSQLä¸ºvector(1536)',
    PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

#### 2.2.2 é˜¿é‡Œäº‘OSSæ–‡ä»¶è¡¨ (ali_oss_file)
```sql
CREATE TABLE `ali_oss_file` (
    `id` BIGINT NOT NULL AUTO_INCREMENT,
    `file_name` VARCHAR(255) COMMENT 'æ–‡ä»¶å',
    `url` VARCHAR(500) COMMENT 'é“¾æ¥åœ°å€',
    `vector_id` TEXT COMMENT 'è¯¥æ–‡ä»¶åˆ†å‰²å‡ºçš„å¤šæ®µå‘é‡æ–‡æœ¬ID',
    `create_time` TIMESTAMP NULL DEFAULT NULL COMMENT 'åˆ›å»ºæ—¶é—´',
    `update_time` TIMESTAMP NULL DEFAULT NULL COMMENT 'æ›´æ–°æ—¶é—´',
    PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='é˜¿é‡Œäº‘OSSæ–‡ä»¶è¡¨';
```

### 2.3 ç³»ç»Ÿç®¡ç†ç›¸å…³è¡¨

#### 2.3.1 æ—¥å¿—ä¿¡æ¯è¡¨ (log_info)
```sql
CREATE TABLE `log_info` (
    `id` BIGINT NOT NULL AUTO_INCREMENT,
    `method_name` VARCHAR(255) COMMENT 'æ–¹æ³•å',
    `class_name` VARCHAR(255) COMMENT 'ç±»ç›®',
    `request_time` DATE COMMENT 'è¯·æ±‚æ—¶é—´æˆ³',
    `request_params` TEXT COMMENT 'è¯·æ±‚å‚æ•°',
    `response` TEXT COMMENT 'å“åº”ç»“æœ',
    PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='æ—¥å¿—ä¿¡æ¯è¡¨';
```

#### 2.3.2 æ•æ„Ÿè¯è¡¨ (sensitive_word)
```sql
CREATE TABLE `sensitive_word` (
    `id` INT NOT NULL AUTO_INCREMENT,
    `word` VARCHAR(255) COMMENT 'æ•æ„Ÿè¯å†…å®¹',
    `category` VARCHAR(255) COMMENT 'æ•æ„Ÿè¯ç±»åˆ«',
    `status` VARCHAR(50) COMMENT 'æ•æ„Ÿè¯çŠ¶æ€',
    `created_at` VARCHAR(50) COMMENT 'åˆ›å»ºæ—¶é—´æˆ³',
    `updated_at` VARCHAR(50) COMMENT 'æ›´æ–°æ—¶é—´æˆ³',
    PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='æ•æ„Ÿè¯è¡¨';
```

#### 2.3.3 æ•æ„Ÿè¯åˆ†ç±»è¡¨ (sensitive_category)
```sql
CREATE TABLE `sensitive_category` (
    `id` INT NOT NULL AUTO_INCREMENT,
    `category_name` VARCHAR(255) COMMENT 'åˆ†ç±»å',
    `created_time` DATE COMMENT 'åˆ›å»ºæ—¶é—´',
    `update_time` DATE COMMENT 'æ›´æ–°æ—¶é—´',
    `status` VARCHAR(50) COMMENT 'çŠ¶æ€',
    PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='æ•æ„Ÿè¯åˆ†ç±»è¡¨';
```

#### 2.3.4 è¯é¢‘ç»Ÿè®¡è¡¨ (word_frequency)
```sql
CREATE TABLE `word_frequency` (
    `id` INT NOT NULL AUTO_INCREMENT,
    `word` VARCHAR(255) COMMENT 'åˆ†è¯',
    `count_num` INT COMMENT 'å‡ºç°é¢‘æ¬¡',
    `business_type` VARCHAR(255) COMMENT 'ä¸šåŠ¡ç±»å‹',
    `create_time` DATE COMMENT 'åˆ›å»ºæ—¶é—´',
    `update_time` DATE COMMENT 'æ›´æ–°æ—¶é—´',
    PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='è¯é¢‘ç»Ÿè®¡è¡¨';
```

### 2.4 è¡¨å…³ç³»è¯´æ˜

#### 2.4.1 æ ¸å¿ƒè¡¨å…³ç³»
- **tb_user**: ç”¨æˆ·åŸºç¡€ä¿¡æ¯è¡¨ï¼Œç³»ç»Ÿçš„æ ¸å¿ƒç”¨æˆ·æ•°æ®
- **vector_store**: å‘é‡å­˜å‚¨è¡¨ï¼Œå­˜å‚¨æ–‡æ¡£çš„å‘é‡åŒ–æ•°æ®ï¼ˆä»PostgreSQLè¿ç§»è€Œæ¥ï¼‰
- **ali_oss_file**: æ–‡ä»¶ç®¡ç†è¡¨ï¼Œè®°å½•ä¸Šä¼ åˆ°é˜¿é‡Œäº‘OSSçš„æ–‡ä»¶ä¿¡æ¯åŠå…¶å¯¹åº”çš„å‘é‡ID

#### 2.4.2 ä¸šåŠ¡æµç¨‹å…³ç³»
1. **æ–‡æ¡£ä¸Šä¼ æµç¨‹**: ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶ â†’ ali_oss_fileè®°å½•æ–‡ä»¶ä¿¡æ¯ â†’ æ–‡æ¡£å‘é‡åŒ– â†’ vector_storeå­˜å‚¨å‘é‡æ•°æ®
2. **æ•æ„Ÿè¯ç®¡ç†**: sensitive_categoryå®šä¹‰åˆ†ç±» â†’ sensitive_wordå­˜å‚¨å…·ä½“æ•æ„Ÿè¯
3. **ç³»ç»Ÿç›‘æ§**: log_infoè®°å½•ç³»ç»Ÿæ“ä½œæ—¥å¿—ï¼Œword_frequencyç»Ÿè®¡è¯é¢‘ä¿¡æ¯

#### 2.4.3 æ•°æ®è¿ç§»è¯´æ˜
- **vector_storeè¡¨**: åŸPostgreSQLçš„vector(1536)å­—æ®µæ”¹ä¸ºMySQLçš„JSONå­—æ®µå­˜å‚¨
- **embeddingå­—æ®µ**: å‘é‡æ•°æ®ä»¥JSONæ•°ç»„æ ¼å¼å­˜å‚¨ï¼Œä¿æŒä¸Milvusçš„å…¼å®¹æ€§
- **metadataå­—æ®µ**: ä½¿ç”¨MySQLçš„JSONç±»å‹å­˜å‚¨å…ƒæ•°æ®ä¿¡æ¯
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    
    INDEX idx_config_key (config_key)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç³»ç»Ÿé…ç½®è¡¨';
```

## 3. æ ¸å¿ƒç®—æ³•è®¾è®¡

### 3.1 æ–‡æ¡£å¤„ç†ç®—æ³•

#### 3.1.1 æ–‡æ¡£åˆ†å—ç®—æ³•ä¼ªä»£ç 
```python
def chunk_document(document_content, chunk_size=1000, overlap=200):
    """
    æ–‡æ¡£åˆ†å—ç®—æ³•
    Args:
        document_content: æ–‡æ¡£å†…å®¹
        chunk_size: åˆ†å—å¤§å°
        overlap: é‡å å¤§å°
    Returns:
        chunks: åˆ†å—åˆ—è¡¨
    """
    chunks = []
    sentences = split_sentences(document_content)
    
    current_chunk = ""
    current_size = 0
    
    for sentence in sentences:
        sentence_size = len(sentence)
        
        if current_size + sentence_size > chunk_size and current_chunk:
            # ä¿å­˜å½“å‰åˆ†å—
            chunks.append({
                'content': current_chunk.strip(),
                'size': current_size,
                'index': len(chunks)
            })
            
            # å¤„ç†é‡å 
            if overlap > 0:
                overlap_content = get_overlap_content(current_chunk, overlap)
                current_chunk = overlap_content + " " + sentence
                current_size = len(overlap_content) + sentence_size
            else:
                current_chunk = sentence
                current_size = sentence_size
        else:
            current_chunk += " " + sentence
            current_size += sentence_size
    
    # å¤„ç†æœ€åä¸€ä¸ªåˆ†å—
    if current_chunk.strip():
        chunks.append({
            'content': current_chunk.strip(),
            'size': current_size,
            'index': len(chunks)
        })
    
    return chunks
```

#### 3.1.2 å‘é‡åŒ–å¤„ç†ç®—æ³•ä¼ªä»£ç 
```python
def vectorize_chunks(chunks, embedding_model):
    """
    åˆ†å—å‘é‡åŒ–ç®—æ³•
    Args:
        chunks: æ–‡æ¡£åˆ†å—åˆ—è¡¨
        embedding_model: å‘é‡åŒ–æ¨¡å‹
    Returns:
        vectors: å‘é‡åˆ—è¡¨
    """
    vectors = []
    batch_size = 32
    
    for i in range(0, len(chunks), batch_size):
        batch_chunks = chunks[i:i + batch_size]
        batch_texts = [chunk['content'] for chunk in batch_chunks]
        
        # æ‰¹é‡å‘é‡åŒ–
        batch_vectors = embedding_model.encode(batch_texts)
        
        for j, vector in enumerate(batch_vectors):
            vectors.append({
                'chunk_id': batch_chunks[j]['index'],
                'vector': vector.tolist(),
                'content': batch_chunks[j]['content'],
                'metadata': {
                    'chunk_size': batch_chunks[j]['size'],
                    'chunk_index': batch_chunks[j]['index']
                }
            })
    
    return vectors
```

### 3.2 æ£€ç´¢ç®—æ³•è®¾è®¡

#### 3.2.1 å‘é‡æ£€ç´¢ç®—æ³•ä¼ªä»£ç 
```python
def vector_search(query, milvus_client, top_k=10, threshold=0.7):
    """
    å‘é‡æ£€ç´¢ç®—æ³•
    Args:
        query: æŸ¥è¯¢æ–‡æœ¬
        milvus_client: Milvuså®¢æˆ·ç«¯
        top_k: è¿”å›ç»“æœæ•°é‡
        threshold: ç›¸ä¼¼åº¦é˜ˆå€¼
    Returns:
        results: æ£€ç´¢ç»“æœ
    """
    # æŸ¥è¯¢å‘é‡åŒ–
    query_vector = embedding_model.encode([query])[0]
    
    # æ„å»ºæ£€ç´¢å‚æ•°
    search_params = {
        "metric_type": "COSINE",
        "params": {"nprobe": 16}
    }
    
    # æ‰§è¡Œå‘é‡æ£€ç´¢
    search_results = milvus_client.search(
        collection_name="vector_store",
        data=[query_vector.tolist()],
        anns_field="vector",
        param=search_params,
        limit=top_k * 2,  # è·å–æ›´å¤šç»“æœç”¨äºè¿‡æ»¤
        output_fields=["content", "metadata", "document_id"]
    )
    
    # ç»“æœè¿‡æ»¤å’Œæ’åº
    filtered_results = []
    for result in search_results[0]:
        if result.distance >= threshold:
            filtered_results.append({
                'id': result.id,
                'content': result.entity.get('content'),
                'similarity': result.distance,
                'document_id': result.entity.get('document_id'),
                'metadata': result.entity.get('metadata')
            })
    
    # å»é‡å’Œé‡æ’åº
    unique_results = remove_duplicates(filtered_results)
    return unique_results[:top_k]
```

### 3.3 RAGç”Ÿæˆç®—æ³•

#### 3.3.1 ä¸Šä¸‹æ–‡æ„å»ºç®—æ³•ä¼ªä»£ç 
```python
def build_rag_context(query, search_results, max_context_length=4000):
    """
    RAGä¸Šä¸‹æ–‡æ„å»ºç®—æ³•
    Args:
        query: ç”¨æˆ·æŸ¥è¯¢
        search_results: æ£€ç´¢ç»“æœ
        max_context_length: æœ€å¤§ä¸Šä¸‹æ–‡é•¿åº¦
    Returns:
        context: æ„å»ºçš„ä¸Šä¸‹æ–‡
    """
    context_parts = []
    current_length = 0
    
    # ç³»ç»Ÿæç¤ºè¯
    system_prompt = "åŸºäºä»¥ä¸‹æ–‡æ¡£å†…å®¹å›ç­”ç”¨æˆ·é—®é¢˜ï¼Œå¦‚æœæ–‡æ¡£ä¸­æ²¡æœ‰ç›¸å…³ä¿¡æ¯ï¼Œè¯·æ˜ç¡®è¯´æ˜ã€‚"
    context_parts.append(system_prompt)
    current_length += len(system_prompt)
    
    # æ·»åŠ æ£€ç´¢åˆ°çš„æ–‡æ¡£å†…å®¹
    for i, result in enumerate(search_results):
        content = result['content']
        content_length = len(content)
        
        if current_length + content_length > max_context_length:
            # æˆªæ–­å†…å®¹
            remaining_length = max_context_length - current_length - 100
            if remaining_length > 0:
                content = content[:remaining_length] + "..."
            else:
                break
        
        context_part = f"\n\næ–‡æ¡£ç‰‡æ®µ{i+1}ï¼ˆç›¸ä¼¼åº¦ï¼š{result['similarity']:.3f}ï¼‰ï¼š\n{content}"
        context_parts.append(context_part)
        current_length += len(context_part)
    
    # æ·»åŠ ç”¨æˆ·é—®é¢˜
    user_question = f"\n\nç”¨æˆ·é—®é¢˜ï¼š{query}\n\nè¯·åŸºäºä¸Šè¿°æ–‡æ¡£å†…å®¹å›ç­”ï¼š"
    context_parts.append(user_question)
    
    return "".join(context_parts)
```

## 4. å‰åç«¯äº¤äº’æ—¶åºå›¾

### 4.1 ç”¨æˆ·ç™»å½•æ—¶åºå›¾
```
ç”¨æˆ· -> å‰ç«¯: è¾“å…¥ç”¨æˆ·åå¯†ç 
å‰ç«¯ -> åç«¯: POST /api/v1/user/login (form-data)
åç«¯ -> MySQL: æŸ¥è¯¢tb_userè¡¨ç”¨æˆ·ä¿¡æ¯
MySQL -> åç«¯: è¿”å›ç”¨æˆ·æ•°æ®
åç«¯ -> åç«¯: éªŒè¯å¯†ç 
åç«¯ -> åç«¯: ç”ŸæˆJWT Token
åç«¯ -> å‰ç«¯: è¿”å›Tokenå’Œç”¨æˆ·ä¿¡æ¯
å‰ç«¯ -> å‰ç«¯: å­˜å‚¨Tokenåˆ°LocalStorage
å‰ç«¯ -> ç”¨æˆ·: æ˜¾ç¤ºç™»å½•æˆåŠŸï¼Œè·³è½¬ä¸»é¡µ
```

### 4.2 æ–‡æ¡£ä¸Šä¼ å¤„ç†æ—¶åºå›¾
```
ç”¨æˆ· -> å‰ç«¯: é€‰æ‹©æ–‡ä»¶ä¸Šä¼ 
å‰ç«¯ -> åç«¯: POST /api/v1/knowledge/file/upload (multipart)
åç«¯ -> OSS: ä¸Šä¼ æ–‡ä»¶åˆ°å¯¹è±¡å­˜å‚¨
OSS -> åç«¯: è¿”å›æ–‡ä»¶URL
åç«¯ -> MySQL: ä¿å­˜æ–‡æ¡£å…ƒæ•°æ®åˆ°ali_oss_fileè¡¨
åç«¯ -> å¼‚æ­¥é˜Ÿåˆ—: å‘é€æ–‡æ¡£å¤„ç†ä»»åŠ¡
åç«¯ -> å‰ç«¯: è¿”å›ä¸Šä¼ æˆåŠŸå“åº”
å¼‚æ­¥å¤„ç†å™¨ -> OSS: ä¸‹è½½æ–‡ä»¶å†…å®¹
å¼‚æ­¥å¤„ç†å™¨ -> Tika: è§£ææ–‡æ¡£å†…å®¹
å¼‚æ­¥å¤„ç†å™¨ -> åˆ†å—å™¨: æ–‡æ¡£åˆ†å—å¤„ç†
å¼‚æ­¥å¤„ç†å™¨ -> å‘é‡åŒ–æœåŠ¡: æ–‡æœ¬å‘é‡åŒ–
å¼‚æ­¥å¤„ç†å™¨ -> Milvus: å­˜å‚¨å‘é‡æ•°æ®åˆ°vector_store
å¼‚æ­¥å¤„ç†å™¨ -> MySQL: æ›´æ–°å¤„ç†çŠ¶æ€
```

### 4.3 æ™ºèƒ½é—®ç­”æ—¶åºå›¾
```
ç”¨æˆ· -> å‰ç«¯: è¾“å…¥é—®é¢˜
å‰ç«¯ -> åç«¯: GET /api/v1/ai/rag?message=é—®é¢˜å†…å®¹
åç«¯ -> å‘é‡åŒ–æœåŠ¡: é—®é¢˜å‘é‡åŒ–
åç«¯ -> Milvus: å‘é‡ç›¸ä¼¼åº¦æ£€ç´¢
Milvus -> åç«¯: è¿”å›ç›¸å…³æ–‡æ¡£ç‰‡æ®µ
åç«¯ -> ä¸Šä¸‹æ–‡æ„å»ºå™¨: æ„å»ºRAGä¸Šä¸‹æ–‡
åç«¯ -> é€šä¹‰åƒé—®API: è°ƒç”¨å¤§è¯­è¨€æ¨¡å‹
é€šä¹‰åƒé—®API -> åç«¯: æµå¼è¿”å›ç”Ÿæˆçš„ç­”æ¡ˆ
åç«¯ -> Redis: ç¼“å­˜å¯¹è¯å†å²
åç«¯ -> MySQL: æŒä¹…åŒ–å¯¹è¯è®°å½•
åç«¯ -> å‰ç«¯: Server-Sent Eventsæµå¼è¿”å›ç­”æ¡ˆ
å‰ç«¯ -> ç”¨æˆ·: å®æ—¶æ˜¾ç¤ºç­”æ¡ˆå†…å®¹
```

### 4.4 ç³»ç»Ÿç›‘æ§æ—¶åºå›¾
```
ç›‘æ§ç³»ç»Ÿ -> åç«¯: å¥åº·æ£€æŸ¥è¯·æ±‚
åç«¯ -> MySQL: æ£€æŸ¥æ•°æ®åº“è¿æ¥
åç«¯ -> Milvus: æ£€æŸ¥å‘é‡æ•°æ®åº“è¿æ¥
åç«¯ -> Redis: æ£€æŸ¥ç¼“å­˜è¿æ¥
åç«¯ -> ç›‘æ§ç³»ç»Ÿ: è¿”å›ç³»ç»ŸçŠ¶æ€
ç›‘æ§ç³»ç»Ÿ -> å‘Šè­¦ç³»ç»Ÿ: å¼‚å¸¸çŠ¶æ€å‘Šè­¦
å‘Šè­¦ç³»ç»Ÿ -> è¿ç»´äººå‘˜: å‘é€å‘Šè­¦é€šçŸ¥
```

## 5. ç¼“å­˜è®¾è®¡

### 5.1 å¤šçº§ç¼“å­˜æ¶æ„
```
åº”ç”¨å±‚ç¼“å­˜ (Caffeine) -> Redisç¼“å­˜ -> æ•°æ®åº“
    â†“
æœ¬åœ°ç¼“å­˜ï¼šçƒ­ç‚¹æ•°æ®ï¼Œ1000æ¡ï¼Œ5åˆ†é’Ÿè¿‡æœŸ
åˆ†å¸ƒå¼ç¼“å­˜ï¼šç”¨æˆ·ä¼šè¯ï¼Œæ£€ç´¢ç»“æœï¼Œ30åˆ†é’Ÿè¿‡æœŸ
æŒä¹…åŒ–å­˜å‚¨ï¼šå®Œæ•´æ•°æ®ï¼Œæ°¸ä¹…å­˜å‚¨
```

### 5.2 ç¼“å­˜ç­–ç•¥è®¾è®¡
- **ç”¨æˆ·ä¿¡æ¯ç¼“å­˜**ï¼šç™»å½•åç¼“å­˜ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ï¼Œè¿‡æœŸæ—¶é—´2å°æ—¶
- **æ–‡æ¡£å…ƒæ•°æ®ç¼“å­˜**ï¼šç¼“å­˜æ–‡æ¡£åˆ—è¡¨å’Œè¯¦æƒ…ï¼Œè¿‡æœŸæ—¶é—´1å°æ—¶
- **æ£€ç´¢ç»“æœç¼“å­˜**ï¼šç¼“å­˜ç›¸åŒæŸ¥è¯¢çš„æ£€ç´¢ç»“æœï¼Œè¿‡æœŸæ—¶é—´30åˆ†é’Ÿ
- **å¯¹è¯å†å²ç¼“å­˜**ï¼šç¼“å­˜æœ€è¿‘çš„å¯¹è¯è®°å½•ï¼Œè¿‡æœŸæ—¶é—´1å°æ—¶
- **ç³»ç»Ÿé…ç½®ç¼“å­˜**ï¼šç¼“å­˜ç³»ç»Ÿé…ç½®ä¿¡æ¯ï¼Œæ‰‹åŠ¨åˆ·æ–°

## 6. å¼‚å¸¸å¤„ç†è®¾è®¡

### 6.1 å¼‚å¸¸åˆ†ç±»å’Œå¤„ç†ç­–ç•¥
- **ä¸šåŠ¡å¼‚å¸¸**ï¼šå‚æ•°æ ¡éªŒå¤±è´¥ã€æƒé™ä¸è¶³ç­‰ï¼Œè¿”å›å…·ä½“é”™è¯¯ä¿¡æ¯
- **ç³»ç»Ÿå¼‚å¸¸**ï¼šæ•°æ®åº“è¿æ¥å¤±è´¥ã€ç¬¬ä¸‰æ–¹æœåŠ¡å¼‚å¸¸ç­‰ï¼Œè¿”å›é€šç”¨é”™è¯¯ä¿¡æ¯
- **ç½‘ç»œå¼‚å¸¸**ï¼šè¶…æ—¶ã€è¿æ¥ä¸­æ–­ç­‰ï¼Œæ”¯æŒé‡è¯•æœºåˆ¶
- **æ•°æ®å¼‚å¸¸**ï¼šæ•°æ®ä¸ä¸€è‡´ã€æ ¼å¼é”™è¯¯ç­‰ï¼Œè®°å½•è¯¦ç»†æ—¥å¿—

### 6.2 å…¨å±€å¼‚å¸¸å¤„ç†å™¨è®¾è®¡
```java
@RestControllerAdvice
public class GlobalExceptionHandler {
    
    @ExceptionHandler(BusinessException.class)
    public Result handleBusinessException(BusinessException e) {
        log.warn("ä¸šåŠ¡å¼‚å¸¸ï¼š{}", e.getMessage());
        return Result.error(e.getCode(), e.getMessage());
    }
    
    @ExceptionHandler(SystemException.class)
    public Result handleSystemException(SystemException e) {
        log.error("ç³»ç»Ÿå¼‚å¸¸ï¼š", e);
        return Result.error(500, "ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•");
    }
}
```

## 7. åŠŸèƒ½å®ç°çŠ¶æ€è¯´æ˜

### 7.1 å·²å®ç°åŠŸèƒ½
- âœ… ç”¨æˆ·ç®¡ç†ï¼šæ³¨å†Œã€ç™»å½•ã€é€€å‡ºã€ä¿®æ”¹å¯†ç ã€ç”¨æˆ·åˆ†é¡µæŸ¥è¯¢
- âœ… çŸ¥è¯†åº“ç®¡ç†ï¼šæ–‡æ¡£ä¸Šä¼ ã€æ–‡æ¡£åˆ—è¡¨æŸ¥è¯¢ã€æ–‡æ¡£ä¸‹è½½
- âœ… æ™ºèƒ½é—®ç­”ï¼šRAGå¯¹è¯æ¥å£ï¼ˆæµå¼è¿”å›ï¼‰ã€æ™®é€šå¯¹è¯æ¥å£
- âœ… ç³»ç»Ÿç®¡ç†ï¼šæ•æ„Ÿè¯ç®¡ç†ã€æ•æ„Ÿè¯åˆ†ç±»ç®¡ç†ã€æ—¥å¿—ç®¡ç†ã€è¯é¢‘ç»Ÿè®¡
- âœ… æµ‹è¯•æ¥å£ï¼šè¿é€šæ€§æµ‹è¯•ã€CORSæµ‹è¯•ã€å¥åº·æ£€æŸ¥
- âœ… AIç»˜å›¾ï¼šåŸºäºæç¤ºè¯çš„å›¾ç‰‡ç”Ÿæˆ

### 7.2 æš‚æœªå®ç°åŠŸèƒ½
- âŒ å¯¹è¯å†å²æŸ¥è¯¢æ¥å£ï¼ˆ/api/v1/chat/historyï¼‰
- âŒ å‘é‡æ£€ç´¢æ¥å£ï¼ˆ/api/v1/vector/searchï¼‰
- âŒ å¯¹è¯å†å²çš„æŒä¹…åŒ–å­˜å‚¨
- âŒ å¯¹è¯ä¼šè¯ç®¡ç†
- âŒ æ–‡æ¡£å¼•ç”¨ä¿¡æ¯è¿”å›
- âŒ å‘é‡æ•°æ®çš„ç›´æ¥æŸ¥è¯¢å’Œç®¡ç†

### 7.3 éƒ¨åˆ†å®ç°åŠŸèƒ½
- ğŸ”„ æ–‡æ¡£å‘é‡åŒ–å¤„ç†ï¼šä¸Šä¼ åŠŸèƒ½å·²å®ç°ï¼Œä½†å‘é‡åŒ–å¤„ç†çš„å¼‚æ­¥ä»»åŠ¡çŠ¶æ€æ›´æ–°æœºåˆ¶éœ€è¦å®Œå–„
- ğŸ”„ ç¼“å­˜æœºåˆ¶ï¼šRedisé…ç½®å·²å°±ç»ªï¼Œä½†å…·ä½“çš„ç¼“å­˜ç­–ç•¥å®ç°éœ€è¦å®Œå–„
- ğŸ”„ æƒé™è®¤è¯ï¼šJWT Tokenæœºåˆ¶å·²å®ç°ï¼Œä½†ç»†ç²’åº¦çš„æƒé™æ§åˆ¶éœ€è¦å®Œå–„

### 7.4 æŠ€æœ¯æ ˆå®ç°çŠ¶æ€
- âœ… Spring Boot 3.x æ¡†æ¶
- âœ… MySQL æ•°æ®åº“åŠè¡¨ç»“æ„
- âœ… é˜¿é‡Œäº‘OSSæ–‡ä»¶å­˜å‚¨
- âœ… Swagger APIæ–‡æ¡£
- âœ… é€šä¹‰åƒé—®AIé›†æˆ
- âœ… æµå¼å“åº”å¤„ç†
- ğŸ”„ Milvuså‘é‡æ•°æ®åº“ï¼ˆé…ç½®å®Œæˆï¼Œä½¿ç”¨å¾…å®Œå–„ï¼‰
- ğŸ”„ Redisç¼“å­˜ï¼ˆé…ç½®å®Œæˆï¼Œä½¿ç”¨å¾…å®Œå–„ï¼‰
- âŒ å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—ï¼ˆéœ€è¦å®ç°ï¼‰