# 主要变动清单

## 1. 界面调整：登录界面与应用主界面分离

### 变动内容
- 实现独立的登录页面路由配置
- 添加全局路由守卫，实现登录状态检查
- 登录成功后自动跳转到主应用界面

### 影响模块
- **前端路由模块**：`src/router/index.ts`, `src/router/config.ts`
- **登录组件**：`src/view/login/RegisterLoginView.vue`
- **主应用入口**：`src/main.ts`

### 技术实现
- 使用Vue Router的`beforeEach`守卫实现路由拦截
- 基于localStorage中的token进行登录状态判断
- 支持角色权限控制的路由访问

---

## 2. 存储变更：向量库从PGVector替换为Milvus

### 变动内容
- 移除PGVector依赖，集成Milvus向量数据库
- 完成向量存储服务的适配与迁移
- 优化文档向量化和检索性能

### 影响模块
- **后端依赖配置**：`pom.xml`
- **向量存储服务**：`src/main/java/com/kinghy/rag/service/impl/AliOssFileServiceImpl.java`
- **知识库控制器**：`src/main/java/com/kinghy/rag/controller/KnowledgeController.java`

### 技术实现
```xml
<!-- 移除PGVector -->
<!--<dependency>
    <groupId>org.springframework.ai</groupId>
    <artifactId>spring-ai-pgvector-store-spring-boot-starter</artifactId>
</dependency>-->

<!-- 新增Milvus支持 -->
<dependency>
    <groupId>org.springframework.ai</groupId>
    <artifactId>spring-ai-starter-vector-store-milvus</artifactId>
</dependency>
```

---

## 3. 工具集成：新增Swagger接口文档

### 变动内容
- 集成Knife4j增强版Swagger UI
- 配置JWT认证集成，支持接口调试
- 添加完整的API文档描述和示例

### 影响模块
- **后端依赖配置**：`pom.xml`
- **OpenAPI配置**：`src/main/java/com/kinghy/rag/config/OpenApiConfig.java`
- **应用配置**：`src/main/resources/application.yml`
- **安全配置**：`src/main/java/com/kinghy/rag/config/ApplicationConfig.java`
- **文档资源**：`src/main/resources/markdown/home.md`

### 技术实现
- **依赖版本**：Knife4j 4.5.0
- **访问地址**：
  - Knife4j UI: http://localhost:8989/doc.html
  - Swagger UI: http://localhost:8989/swagger-ui.html
- **认证集成**：支持Bearer Token全局认证
- **界面优化**：中文界面、自定义首页、分组管理

---

## 4. 安全增强：JWT认证机制完善

### 变动内容
- 修复前端文件上传接口JWT token缺失问题
- 统一前端HTTP请求的认证头处理
- 完善后端JWT拦截器的token验证逻辑

### 影响模块
- **前端HTTP客户端**：`src/utils/httpClient.ts`
- **前端API服务**：`src/api/KnowHubApi.ts`, `src/api/StreamApi.ts`
- **前端请求拦截器**：`src/http/index.ts`
- **后端JWT拦截器**：`src/main/java/com/kinghy/rag/common/JwtTokenUserInterceptor.java`

### 技术实现
- 为文件上传服务添加JWT token拦截器
- 统一Bearer Token格式处理
- 增强token验证的错误处理和日志记录

---

## 5. 开发体验优化：调试工具集成

### 变动内容
- 添加JWT认证测试工具
- 集成前端HTTP请求调试功能
- 完善错误处理和日志输出

### 影响模块
- **前端调试工具**：`src/utils/authTest.ts`
- **前端HTTP服务**：`src/http/index.ts`
- **后端日志配置**：`src/main/resources/application.yml`

### 技术实现
- 浏览器控制台可调用`testJWT()`进行认证测试
- 请求/响应拦截器增加详细日志
- 支持开发环境的调试模式

---

## 6. 配置管理：应用配置结构化

### 变动内容
- 重构application.yml配置文件结构
- 添加Knife4j工具配置
- 优化JWT、CORS等安全配置

### 影响模块
- **应用配置**：`src/main/resources/application.yml`
- **安全配置**：`src/main/java/com/kinghy/rag/config/ApplicationConfig.java`

### 配置要点
- Knife4j界面中文化配置
- JWT token名称和过期时间配置
- 文件上传大小限制配置
- 跨域访问策略配置

---

## 7. 功能增强：聊天历史记录持久化

### 变动内容
- 修复页面刷新后聊天记录丢失的问题
- 实现智能历史记录加载策略
- 完善会话管理和状态持久化
- 优化用户体验和错误处理机制

### 影响模块
- **前端API服务**：`src/api/ChatApi.ts`
- **前端聊天组件**：`src/view/ragChat/RagChatView.vue`
- **前端工具类**：`src/utils/fetchWrapper.ts`
- **后端聊天控制器**：`src/main/java/com/kinghy/rag/controller/ChatController.java`
- **后端会话控制器**：`src/main/java/com/kinghy/rag/controller/ChatSessionController.java`

### 技术实现

#### 前端API扩展
```typescript
// 新增历史记录API
export const getChatHistoryApi = async (sessionId?: string, limit: number = 50): Promise<ChatMessageVO[]> => {
  const params = new URLSearchParams();
  if (sessionId) params.append('sessionId', sessionId);
  params.append('limit', limit.toString());
  
  const url = `/api/v1/chat/history?${params.toString()}`;
  const response = await fetchWithAuthJSON(url);
  return response.data || [];
};
```

#### 智能加载策略
```typescript
// 三级加载策略实现
onMounted(async () => {
  // 1. 优先从服务器加载
  const serverHistoryLoaded = await loadChatHistoryFromServer()
  
  if (!serverHistoryLoaded) {
    // 2. 加载本地缓存
    const localHistoryLoaded = loadMessagesFromStorage()
    
    if (!localHistoryLoaded) {
      // 3. 默认欢迎消息
      setDefaultWelcomeMessage()
    }
  }
})
```

#### 会话管理优化
- 会话ID持久化存储：`localStorage.setItem(SESSION_STORAGE_KEY, sessionId)`
- 消息发送时自动包含会话ID参数
- 支持手动刷新历史记录功能

#### 用户体验改进
- 加载状态提示：`isLoadingHistory` 状态管理
- 错误处理机制：网络异常时的降级策略
- 重试机制：网络错误时最多重试3次
- UI优化：防抖更新，避免过度渲染

### 接口变更
- **新增接口**：`GET /api/v1/chat/history` - 获取聊天历史记录
- **新增接口**：`GET /api/v1/chat/session/list` - 获取会话列表
- **参数增强**：聊天接口支持 `sessionId` 参数传递

### 数据结构
```typescript
// 前端消息接口扩展
export interface ChatMessage {
  role: 'user' | 'assistant';
  content: string;
  isTyping?: boolean;
  id?: string;           // 新增：消息ID
  createTime?: string;   // 新增：创建时间
  messageType?: string;  // 新增：消息类型
}

// 后端消息VO接口
export interface ChatMessageVO {
  id: string;
  sessionId: string;
  userId: number;
  messageType: 'USER' | 'ASSISTANT';
  content: string;
  metadata?: string;
  createTime: string;
}
```

### 测试验证
- ✅ 页面刷新后正确恢复聊天历史
- ✅ 会话连续性保持良好
- ✅ 网络异常时有合理降级策略
- ✅ 用户体验流畅，状态提示清晰
- ✅ 手动刷新功能正常工作

### 性能优化
- 历史记录分页加载，默认限制100条
- UI更新频率控制，每50ms最多更新一次
- 本地存储作为缓存备份，减少服务器请求
- 智能重试机制，避免无效请求

---

## 变动总结

| 变动类型 | 主要技术栈 | 影响范围 | 完成状态 |
|---------|-----------|---------|---------|
| 前端路由重构 | Vue Router | 前端导航体系 | ✅ 已完成 |
| 向量数据库迁移 | Spring AI + Milvus | 后端存储层 | ✅ 已完成 |
| API文档集成 | Knife4j + OpenAPI | 开发调试 | ✅ 已完成 |
| 认证机制完善 | JWT + 拦截器 | 前后端安全 | ✅ 已完成 |
| 开发工具优化 | 调试工具集 | 开发体验 | ✅ 已完成 |
| 聊天历史记录持久化 | Vue 3 + Spring Boot | 前后端聊天功能 | ✅ 已完成 |

**最后更新时间**：2026年1月9日  
**文档版本**：v1.1.0

---

## 8. 编译错误修复：Milvus API 更新和类型转换问题

### 变动内容
- 修复 Milvus Java SDK 中过时方法 `withFieldTypes()` 的使用
- 解决 `AliOssFile` 实体类 ID 字段类型不匹配问题
- 确保项目编译通过，消除类型转换错误

### 影响模块
- **向量存储管理器**：`src/main/java/com/kinghy/rag/service/impl/VectorStoreManagerImpl.java`
- **OSS文件实体类**：`src/main/java/com/kinghy/rag/entity/AliOssFile.java`

### 技术实现

#### Milvus API 更新
```java
// 修复前（过时方法）
CreateCollectionParam createCollectionParam = CreateCollectionParam.newBuilder()
    .withCollectionName(collectionName)
    .withDescription("知识库 " + knowledgeBaseId + " 的向量集合")
    .withFieldTypes(fieldsSchema)  // 已过时
    .build();

// 修复后（新方法）
CreateCollectionParam createCollectionParam = CreateCollectionParam.newBuilder()
    .withCollectionName(collectionName)
    .withDescription("知识库 " + knowledgeBaseId + " 的向量集合")
    .withSchema(CollectionSchemaParam.newBuilder()
            .withFieldTypes(fieldsSchema)
            .build())
    .build();
```

#### 数据类型统一
```java
// AliOssFile 实体类 ID 字段类型修复
// 修复前
@TableId
private Integer id;  // 与业务方法参数类型不匹配

// 修复后
@TableId
private Long id;     // 统一使用 Long 类型，与 MyBatis Plus 规范一致
```

### 解决的问题
1. **编译警告消除**：移除 Milvus SDK 过时方法的使用警告
2. **类型转换错误**：修复 `java.lang.Integer无法转换为java.lang.Long` 的编译错误
3. **代码规范性**：统一主键字段类型，符合 MyBatis Plus 最佳实践

### 测试验证
- ✅ 项目编译成功，无编译错误和警告
- ✅ Milvus 向量集合创建功能正常
- ✅ OSS 文件删除功能类型匹配正确
- ✅ 数据库操作与实体类字段类型一致

### 兼容性说明
- **向前兼容**：新的 Milvus API 调用方式向前兼容
- **数据库兼容**：Long 类型主键与 MySQL 的 BIGINT 类型完全兼容
- **业务逻辑无影响**：修复仅涉及类型声明，不影响现有业务逻辑

---

## 变动总结（更新）

| 变动类型 | 主要技术栈 | 影响范围 | 完成状态 |
|---------|-----------|---------|---------|
| 前端路由重构 | Vue Router | 前端导航体系 | ✅ 已完成 |
| 向量数据库迁移 | Spring AI + Milvus | 后端存储层 | ✅ 已完成 |
| API文档集成 | Knife4j + OpenAPI | 开发调试 | ✅ 已完成 |
| 认证机制完善 | JWT + 拦截器 | 前后端安全 | ✅ 已完成 |
| 开发工具优化 | 调试工具集 | 开发体验 | ✅ 已完成 |
| 聊天历史记录持久化 | Vue 3 + Spring Boot | 前后端聊天功能 | ✅ 已完成 |
| 编译错误修复 | Milvus SDK + MyBatis Plus | 后端代码质量 | ✅ 已完成 |

---

## 9. 前端API路径规范化：消除硬编码路径

### 变动内容
- 修复前端代码中硬编码的 `/api/v1` 路径问题
- 统一使用 `BASE_URL` 配置进行API路径管理
- 确保前端API调用的一致性和可维护性

### 影响模块
- **前端API服务**：`src/api/ChatApi.ts`
- **前端聊天组件**：`src/view/ragChat/RagChatView.vue`
- **前端配置文件**：`src/http/config.ts`

### 技术实现

#### API路径统一化
```typescript
// 修复前（硬编码路径）
const url = `/api/v1${ChatApi.History}?${params.toString()}`;
const url = `/api/v1${ChatApi.Sessions}`;
const url = `/api/v1${ChatApi.RagChat}?${params.toString()}`;

// 修复后（使用BASE_URL配置）
import { BASE_URL } from '@/http/config';
const url = `${BASE_URL}${ChatApi.History}?${params.toString()}`;
const url = `${BASE_URL}${ChatApi.Sessions}`;
const url = `${BASE_URL}${ChatApi.RagChat}?${params.toString()}`;
```

#### 聊天组件路径修复
```typescript
// 修复前（硬编码路径）
const baseUrl = apiMethod === sendChatMessageApi ? '/api/v1/chat/stream' : '/api/v1/ai/rag'

// 修复后（使用常量）
const baseUrl = apiMethod === sendChatMessageApi ? ChatApi.Chat : ChatApi.RagChat
const url = `${BASE_URL}${baseUrl}?${params.toString()}`
```

### 解决的问题
1. **路径维护困难**：消除分散在各处的硬编码API路径
2. **配置不一致**：统一使用 `BASE_URL` 配置，避免路径重复
3. **代码可维护性**：集中管理API基础路径，便于后续修改
4. **开发体验**：减少因路径错误导致的调试时间

### 修复范围
- **ChatApi.ts**：修复 `getChatHistoryApi`、`getChatSessionsApi`、`sendRagChatMessageWithKnowledgeBasesApi` 函数
- **RagChatView.vue**：修复流式聊天请求的URL构建逻辑
- **路径验证**：确保所有API调用都通过配置文件管理

### 测试验证
- ✅ 前端构建成功：`npm run build` 通过
- ✅ TypeScript类型检查通过：`vue-tsc --noEmit` 无错误
- ✅ API路径统一：所有硬编码 `/api/v1` 已消除
- ✅ 配置集中化：仅在 `config.ts` 中定义 `BASE_URL`

### 代码规范改进
- **统一导入**：所有需要BASE_URL的文件统一从 `@/http/config` 导入
- **常量使用**：优先使用 `ChatApi` 常量而非硬编码字符串
- **路径拼接**：使用模板字符串进行路径拼接，提高可读性

### 配置管理优化
```typescript
// 集中化配置管理
// src/http/config.ts
export const BASE_URL = "/api/v1";

// 各API服务统一使用
import { BASE_URL } from '@/http/config';
const url = `${BASE_URL}${endpoint}`;
```

### 维护性提升
- **单点配置**：API基础路径只需在一处修改
- **类型安全**：TypeScript确保路径拼接的类型正确性
- **开发效率**：减少因路径配置错误导致的问题排查时间

---

## 变动总结（更新）

| 变动类型 | 主要技术栈 | 影响范围 | 完成状态 |
|---------|-----------|---------|---------|
| 前端路由重构 | Vue Router | 前端导航体系 | ✅ 已完成 |
| 向量数据库迁移 | Spring AI + Milvus | 后端存储层 | ✅ 已完成 |
| API文档集成 | Knife4j + OpenAPI | 开发调试 | ✅ 已完成 |
| 认证机制完善 | JWT + 拦截器 | 前后端安全 | ✅ 已完成 |
| 开发工具优化 | 调试工具集 | 开发体验 | ✅ 已完成 |
| 聊天历史记录持久化 | Vue 3 + Spring Boot | 前后端聊天功能 | ✅ 已完成 |
| 编译错误修复 | Milvus SDK + MyBatis Plus | 后端代码质量 | ✅ 已完成 |
| 前端API路径规范化 | TypeScript + Vue 3 | 前端代码质量 | ✅ 已完成 |

**最后更新时间**：2026年1月9日  
**文档版本**：v1.3.0

---

## 10. 数据一致性修复：知识库文件计数同步问题

### 变动内容
- 修复知识库文件计数与实际文件数量不一致的问题
- 添加系统管理接口，支持数据一致性修复
- 完善前端管理功能，提供可视化修复操作
- 建立数据一致性检查和预防机制

### 问题背景
数据库中通过脚本直接插入的知识库记录，其 `file_count` 字段为0，但实际存在文件记录，导致前端界面显示错误。

### 影响模块
- **后端管理控制器**：`src/main/java/com/kinghy/rag/controller/AdminController.java`（新增）
- **知识库服务接口**：`src/main/java/com/kinghy/rag/service/KnowledgeBaseService.java`
- **知识库服务实现**：`src/main/java/com/kinghy/rag/service/impl/KnowledgeBaseServiceImpl.java`
- **知识库数据访问层**：`src/main/java/com/kinghy/rag/mapper/KnowledgeBaseMapper.java`
- **MyBatis映射文件**：`src/main/resources/mapper/KnowledgeBaseMapper.xml`
- **前端管理API**：`src/api/AdminApi.ts`（新增）
- **前端知识库管理页面**：`src/view/knowledge/KnowledgeManagementView.vue`
- **前端样式文件**：`src/styles/knowledge-management.scss`
- **数据修复脚本**：`src/main/resources/sql/fix_knowledge_base_file_count.sql`（新增）

### 技术实现

#### 后端修复接口
```java
// AdminController.java - 新增系统管理控制器
@PostMapping("/fix-knowledge-base-file-count")
public BaseResponse<String> fixKnowledgeBaseFileCount() {
    int fixedCount = knowledgeBaseService.fixFileCount();
    String message = String.format("修复完成，共修复了 %d 个知识库的文件计数", fixedCount);
    return ResultUtils.success(message);
}
```

#### 数据修复SQL
```sql
-- 批量修复所有知识库的文件计数
UPDATE tb_knowledge_base kb
SET file_count = (
    SELECT COUNT(*)
    FROM tb_knowledge_base_file kbf
    WHERE kbf.knowledge_base_id = kb.id
),
update_time = NOW()
WHERE EXISTS (
    SELECT 1
    FROM tb_knowledge_base_file kbf
    WHERE kbf.knowledge_base_id = kb.id
);
```

#### 前端修复功能
```vue
<!-- 知识库管理页面添加修复按钮 -->
<div class="header-actions">
  <el-button type="warning" @click="handleFixFileCount" :loading="isFixing">
    <el-icon><Tools /></el-icon>
    修复文件计数
  </el-button>
  <el-button type="primary" @click="showCreateDialog = true">
    <el-icon><Plus /></el-icon>
    创建知识库
  </el-button>
</div>
```

#### 修复流程实现
```typescript
// 前端修复处理逻辑
const handleFixFileCount = async () => {
  try {
    await ElMessageBox.confirm(
      '此操作将修复所有知识库的文件计数，确保数据一致性。是否继续？',
      '修复文件计数',
      {
        confirmButtonText: '确定修复',
        cancelButtonText: '取消',
        type: 'warning',
      }
    )
    
    isFixing.value = true
    const response = await fixKnowledgeBaseFileCountApi()
    
    if (response.code === 0) {
      ElMessage.success(response.data || '文件计数修复成功')
      loadKnowledgeBases() // 刷新列表
    } else {
      ElMessage.error(response.message || '修复失败')
    }
  } catch (error) {
    if (error !== 'cancel') {
      console.error('修复文件计数失败:', error)
      ElMessage.error('修复文件计数失败')
    }
  } finally {
    isFixing.value = false
  }
}
```

### 解决的问题
1. **数据显示错误**：知识库管理页面显示"0个文件"，实际有文件存在
2. **AI问答功能影响**：RAG问答界面知识库选择显示错误
3. **数据一致性问题**：数据库计数字段与实际数据不符
4. **用户体验问题**：界面信息不准确，影响用户判断

### 新增功能
- **系统管理接口**：`/admin/fix-knowledge-base-file-count` 修复接口
- **前端修复按钮**：知识库管理页面一键修复功能
- **数据验证脚本**：SQL脚本支持修复和验证
- **用户交互优化**：确认对话框、加载状态、结果提示

### 预防措施
1. **数据初始化规范**：
   - 数据脚本执行后进行完整性验证
   - 初始化数据时同步更新相关计数字段
   - 提供数据一致性检查SQL

2. **代码质量改进**：
   - 文件上传和删除操作确保计数同步
   - 添加事务完整性保障
   - 完善异常处理和回滚机制

3. **监控和告警**：
   - 建议添加定期数据一致性检查
   - 实现计数异常的监控告警
   - 完善操作日志记录

### 测试验证
- ✅ 修复功能正常：点击修复按钮成功更新文件计数
- ✅ 界面显示正确：知识库管理页面显示正确的文件数量
- ✅ AI问答功能正常：RAG问答界面知识库选择显示正确
- ✅ 数据一致性：数据库计数字段与实际文件数量一致
- ✅ 用户体验良好：操作流程清晰，状态提示完整

### 文档更新
- **问题解决记录**：`docs/07-问题解决记录/知识库文件计数不一致问题解决方案.md`
- **变动清单更新**：记录本次修复的详细信息
- **API文档**：新增管理接口的文档说明

### 代码规范
- **作者标识**：所有新增文件都添加了 `@author yunzhongxiaoma` 标识
- **中文注释**：代码注释和文档说明使用中文
- **统一格式**：遵循项目既定的代码格式规范

---

## 变动总结（最终更新）

| 变动类型 | 主要技术栈 | 影响范围 | 完成状态 |
|---------|-----------|---------|---------|
| 前端路由重构 | Vue Router | 前端导航体系 | ✅ 已完成 |
| 向量数据库迁移 | Spring AI + Milvus | 后端存储层 | ✅ 已完成 |
| API文档集成 | Knife4j + OpenAPI | 开发调试 | ✅ 已完成 |
| 认证机制完善 | JWT + 拦截器 | 前后端安全 | ✅ 已完成 |
| 开发工具优化 | 调试工具集 | 开发体验 | ✅ 已完成 |
| 聊天历史记录持久化 | Vue 3 + Spring Boot | 前后端聊天功能 | ✅ 已完成 |
| 编译错误修复 | Milvus SDK + MyBatis Plus | 后端代码质量 | ✅ 已完成 |
| 前端API路径规范化 | TypeScript + Vue 3 | 前端代码质量 | ✅ 已完成 |
| 数据一致性修复 | Spring Boot + Vue 3 | 知识库管理功能 | ✅ 已完成 |

**最后更新时间**：2026年1月9日  
**文档版本**：v1.4.0