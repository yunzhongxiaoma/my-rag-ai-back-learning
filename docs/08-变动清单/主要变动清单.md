# 主要变动清单

## 1. 界面调整：登录界面与应用主界面分离

### 变动内容
- 实现独立的登录页面路由配置
- 添加全局路由守卫，实现登录状态检查
- 登录成功后自动跳转到主应用界面

### 影响模块
- **前端路由模块**：`src/router/index.ts`, `src/router/config.ts`
- **登录组件**：`src/view/login/RegisterLoginView.vue`
- **主应用入口**：`src/main.ts`

### 技术实现
- 使用Vue Router的`beforeEach`守卫实现路由拦截
- 基于localStorage中的token进行登录状态判断
- 支持角色权限控制的路由访问

---

## 2. 存储变更：向量库从PGVector替换为Milvus

### 变动内容
- 移除PGVector依赖，集成Milvus向量数据库
- 完成向量存储服务的适配与迁移
- 优化文档向量化和检索性能

### 影响模块
- **后端依赖配置**：`pom.xml`
- **向量存储服务**：`src/main/java/com/kinghy/rag/service/impl/AliOssFileServiceImpl.java`
- **知识库控制器**：`src/main/java/com/kinghy/rag/controller/KnowledgeController.java`

### 技术实现
```xml
<!-- 移除PGVector -->
<!--<dependency>
    <groupId>org.springframework.ai</groupId>
    <artifactId>spring-ai-pgvector-store-spring-boot-starter</artifactId>
</dependency>-->

<!-- 新增Milvus支持 -->
<dependency>
    <groupId>org.springframework.ai</groupId>
    <artifactId>spring-ai-starter-vector-store-milvus</artifactId>
</dependency>
```

---

## 3. 工具集成：新增Swagger接口文档

### 变动内容
- 集成Knife4j增强版Swagger UI
- 配置JWT认证集成，支持接口调试
- 添加完整的API文档描述和示例

### 影响模块
- **后端依赖配置**：`pom.xml`
- **OpenAPI配置**：`src/main/java/com/kinghy/rag/config/OpenApiConfig.java`
- **应用配置**：`src/main/resources/application.yml`
- **安全配置**：`src/main/java/com/kinghy/rag/config/ApplicationConfig.java`
- **文档资源**：`src/main/resources/markdown/home.md`

### 技术实现
- **依赖版本**：Knife4j 4.5.0
- **访问地址**：
  - Knife4j UI: http://localhost:8989/doc.html
  - Swagger UI: http://localhost:8989/swagger-ui.html
- **认证集成**：支持Bearer Token全局认证
- **界面优化**：中文界面、自定义首页、分组管理

---

## 4. 安全增强：JWT认证机制完善

### 变动内容
- 修复前端文件上传接口JWT token缺失问题
- 统一前端HTTP请求的认证头处理
- 完善后端JWT拦截器的token验证逻辑

### 影响模块
- **前端HTTP客户端**：`src/utils/httpClient.ts`
- **前端API服务**：`src/api/KnowHubApi.ts`, `src/api/StreamApi.ts`
- **前端请求拦截器**：`src/http/index.ts`
- **后端JWT拦截器**：`src/main/java/com/kinghy/rag/common/JwtTokenUserInterceptor.java`

### 技术实现
- 为文件上传服务添加JWT token拦截器
- 统一Bearer Token格式处理
- 增强token验证的错误处理和日志记录

---

## 5. 开发体验优化：调试工具集成

### 变动内容
- 添加JWT认证测试工具
- 集成前端HTTP请求调试功能
- 完善错误处理和日志输出

### 影响模块
- **前端调试工具**：`src/utils/authTest.ts`
- **前端HTTP服务**：`src/http/index.ts`
- **后端日志配置**：`src/main/resources/application.yml`

### 技术实现
- 浏览器控制台可调用`testJWT()`进行认证测试
- 请求/响应拦截器增加详细日志
- 支持开发环境的调试模式

---

## 6. 配置管理：应用配置结构化

### 变动内容
- 重构application.yml配置文件结构
- 添加Knife4j工具配置
- 优化JWT、CORS等安全配置

### 影响模块
- **应用配置**：`src/main/resources/application.yml`
- **安全配置**：`src/main/java/com/kinghy/rag/config/ApplicationConfig.java`

### 配置要点
- Knife4j界面中文化配置
- JWT token名称和过期时间配置
- 文件上传大小限制配置
- 跨域访问策略配置

---

## 7. 功能增强：聊天历史记录持久化

### 变动内容
- 修复页面刷新后聊天记录丢失的问题
- 实现智能历史记录加载策略
- 完善会话管理和状态持久化
- 优化用户体验和错误处理机制

### 影响模块
- **前端API服务**：`src/api/ChatApi.ts`
- **前端聊天组件**：`src/view/ragChat/RagChatView.vue`
- **前端工具类**：`src/utils/fetchWrapper.ts`
- **后端聊天控制器**：`src/main/java/com/kinghy/rag/controller/ChatController.java`
- **后端会话控制器**：`src/main/java/com/kinghy/rag/controller/ChatSessionController.java`

### 技术实现

#### 前端API扩展
```typescript
// 新增历史记录API
export const getChatHistoryApi = async (sessionId?: string, limit: number = 50): Promise<ChatMessageVO[]> => {
  const params = new URLSearchParams();
  if (sessionId) params.append('sessionId', sessionId);
  params.append('limit', limit.toString());
  
  const url = `/api/v1/chat/history?${params.toString()}`;
  const response = await fetchWithAuthJSON(url);
  return response.data || [];
};
```

#### 智能加载策略
```typescript
// 三级加载策略实现
onMounted(async () => {
  // 1. 优先从服务器加载
  const serverHistoryLoaded = await loadChatHistoryFromServer()
  
  if (!serverHistoryLoaded) {
    // 2. 加载本地缓存
    const localHistoryLoaded = loadMessagesFromStorage()
    
    if (!localHistoryLoaded) {
      // 3. 默认欢迎消息
      setDefaultWelcomeMessage()
    }
  }
})
```

#### 会话管理优化
- 会话ID持久化存储：`localStorage.setItem(SESSION_STORAGE_KEY, sessionId)`
- 消息发送时自动包含会话ID参数
- 支持手动刷新历史记录功能

#### 用户体验改进
- 加载状态提示：`isLoadingHistory` 状态管理
- 错误处理机制：网络异常时的降级策略
- 重试机制：网络错误时最多重试3次
- UI优化：防抖更新，避免过度渲染

### 接口变更
- **新增接口**：`GET /api/v1/chat/history` - 获取聊天历史记录
- **新增接口**：`GET /api/v1/chat/session/list` - 获取会话列表
- **参数增强**：聊天接口支持 `sessionId` 参数传递

### 数据结构
```typescript
// 前端消息接口扩展
export interface ChatMessage {
  role: 'user' | 'assistant';
  content: string;
  isTyping?: boolean;
  id?: string;           // 新增：消息ID
  createTime?: string;   // 新增：创建时间
  messageType?: string;  // 新增：消息类型
}

// 后端消息VO接口
export interface ChatMessageVO {
  id: string;
  sessionId: string;
  userId: number;
  messageType: 'USER' | 'ASSISTANT';
  content: string;
  metadata?: string;
  createTime: string;
}
```

### 测试验证
- ✅ 页面刷新后正确恢复聊天历史
- ✅ 会话连续性保持良好
- ✅ 网络异常时有合理降级策略
- ✅ 用户体验流畅，状态提示清晰
- ✅ 手动刷新功能正常工作

### 性能优化
- 历史记录分页加载，默认限制100条
- UI更新频率控制，每50ms最多更新一次
- 本地存储作为缓存备份，减少服务器请求
- 智能重试机制，避免无效请求

---

## 变动总结

| 变动类型 | 主要技术栈 | 影响范围 | 完成状态 |
|---------|-----------|---------|---------|
| 前端路由重构 | Vue Router | 前端导航体系 | ✅ 已完成 |
| 向量数据库迁移 | Spring AI + Milvus | 后端存储层 | ✅ 已完成 |
| API文档集成 | Knife4j + OpenAPI | 开发调试 | ✅ 已完成 |
| 认证机制完善 | JWT + 拦截器 | 前后端安全 | ✅ 已完成 |
| 开发工具优化 | 调试工具集 | 开发体验 | ✅ 已完成 |
| 聊天历史记录持久化 | Vue 3 + Spring Boot | 前后端聊天功能 | ✅ 已完成 |

**最后更新时间**：2026年1月9日  
**文档版本**：v1.1.0