# 数据库初始化指南

## 📋 概述

本文档提供了RAG AI后端项目的数据库初始化步骤和说明。项目使用MySQL作为主数据库，Milvus作为向量数据库。

## 🗄️ 数据库架构

### 主要数据库
- **MySQL**: 存储业务数据（用户、文件、日志等）
- **Milvus**: 存储向量数据（文档向量化后的数据）
- **Redis**: 缓存和会话存储

## 🚀 MySQL数据库初始化

### 1. 创建数据库
```sql
-- 创建数据库
CREATE DATABASE my_rag CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 使用数据库
USE my_rag;
```

### 2. 执行初始化脚本
项目提供了完整的初始化SQL脚本：

```bash
# 方式1：使用MySQL命令行
mysql -u root -p my_rag < src/main/resources/sql/init.sql

# 方式2：在MySQL客户端中执行
mysql> source /path/to/your/project/src/main/resources/sql/init.sql;
```

### 3. 验证表创建
```sql
-- 查看所有表
SHOW TABLES;

-- 应该看到以下表：
-- +------------------+
-- | Tables_in_my_rag |
-- +------------------+
-- | ali_oss_file     |
-- | log_info         |
-- | sensitive_category|
-- | sensitive_word   |
-- | tb_user          |
-- | vector_store     |
-- | word_frequency   |
-- +------------------+

-- 查看用户表结构
DESC tb_user;

-- 验证默认管理员用户
SELECT id, name, user_name, status FROM tb_user WHERE user_name = 'admin';
```

## 📊 表结构说明

### 核心业务表

#### tb_user (用户表)
- **用途**: 存储系统用户信息
- **关键字段**: 
  - `user_name`: 用户名（登录用）
  - `password`: 密码（MD5加密）
  - `status`: 用户状态（0禁用，1启用）
- **默认数据**: 管理员账户 admin/admin

#### vector_store (向量存储表)
- **用途**: 存储文档的向量化数据
- **关键字段**:
  - `content`: 原始文本内容
  - `embedding`: 向量数据（JSON格式）
  - `metadata`: 元数据信息
- **说明**: 从PostgreSQL的vector类型迁移到MySQL的JSON类型

#### ali_oss_file (文件表)
- **用途**: 记录上传到阿里云OSS的文件信息
- **关键字段**:
  - `file_name`: 文件名
  - `url`: OSS访问链接
  - `vector_id`: 关联的向量ID列表

### 系统管理表

#### sensitive_word & sensitive_category
- **用途**: 敏感词管理系统
- **功能**: 内容审核和过滤

#### log_info (日志表)
- **用途**: 记录系统操作日志
- **功能**: 系统监控和问题排查

#### word_frequency (词频表)
- **用途**: 统计词汇出现频率
- **功能**: 数据分析和优化

## 🔧 Milvus向量数据库初始化

### 1. 启动Milvus服务
```bash
# 使用Docker Compose启动
cd my-rag-ai-back-learning
docker compose -f docs/docker-milvus-attu-compose.yml up -d

# 检查服务状态
docker compose -f docs/docker-milvus-attu-compose.yml ps
```

### 2. 验证Milvus连接
```bash
# 检查Milvus健康状态
curl http://localhost:9091/healthz

# 访问Attu管理界面（可选）
# 浏览器打开: http://localhost:3000
```

### 3. 集合自动创建
应用启动时会自动创建Milvus集合：
- **集合名**: vector_store
- **向量维度**: 1536
- **索引类型**: IVF_FLAT
- **相似度度量**: COSINE

## 🔄 数据迁移说明

### PostgreSQL到MySQL迁移要点

#### 1. 向量数据类型转换
```sql
-- PostgreSQL (原始)
embedding vector(1536)

-- MySQL (迁移后)
embedding JSON COMMENT '向量数据，存储为JSON数组'
```

#### 2. 数据格式转换
- **向量数据**: 从PostgreSQL的vector类型转为JSON数组格式
- **时间字段**: 部分字段从TIMESTAMP改为DATE类型
- **字符集**: 统一使用utf8mb4字符集

#### 3. 索引优化
- 移除了复杂的外键约束
- 简化了索引结构
- 保持了查询性能

## 🧪 测试数据

### 默认用户账户
```sql
-- 管理员账户
用户名: admin
密码: admin (MD5: 21232f297a57a5a743894a0e4a801fc3)
状态: 启用
```

### 测试数据插入（可选）
```sql
-- 插入测试敏感词分类
INSERT INTO sensitive_category (category_name, created_time, status) VALUES 
('政治敏感', '2024-01-07', 'ACTIVE'),
('暴力内容', '2024-01-07', 'ACTIVE');

-- 插入测试敏感词
INSERT INTO sensitive_word (word, category, status, created_at) VALUES 
('测试敏感词', '政治敏感', 'ACTIVE', '2024-01-07');
```

## 🔍 常见问题

### Q: 数据库连接失败？
A: 检查以下配置：
1. MySQL服务是否启动
2. 数据库名称是否正确（my_rag）
3. 用户名密码是否正确
4. 端口是否正确（默认3306）

### Q: 表创建失败？
A: 可能的原因：
1. MySQL版本过低（需要5.7+支持JSON类型）
2. 字符集不支持（需要utf8mb4）
3. 权限不足

### Q: Milvus连接失败？
A: 检查：
1. Milvus服务是否正常启动
2. 端口19530是否可访问
3. 网络连接是否正常

### Q: 向量数据存储问题？
A: 注意：
1. MySQL的JSON字段有大小限制
2. 向量维度必须与配置一致（1536）
3. 数据格式必须是有效的JSON数组

## 📝 维护建议

### 定期维护任务
1. **数据备份**: 定期备份MySQL数据
2. **日志清理**: 定期清理log_info表的历史数据
3. **向量优化**: 定期优化Milvus索引
4. **性能监控**: 监控数据库性能指标

### 备份脚本示例
```bash
#!/bin/bash
# 数据库备份脚本
DATE=$(date +%Y%m%d_%H%M%S)
mysqldump -u root -p my_rag > backup_${DATE}.sql
echo "数据库备份完成: backup_${DATE}.sql"
```

---

**更新时间**: 2024-01-07  
**适用版本**: v1.0.0  
**维护人员**: 开发团队