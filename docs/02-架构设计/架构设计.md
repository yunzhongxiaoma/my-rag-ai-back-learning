# 架构设计文档

## 1. 系统整体架构

### 1.1 系统架构概述
本系统采用分层架构设计，基于Spring Boot构建微服务架构的RAG智能问答系统。整体架构分为以下几个层次：

```
┌─────────────────────────────────────────────────────────────┐
│                    前端展示层 (Vue.js)                        │
├─────────────────────────────────────────────────────────────┤
│                    API网关层 (Spring Gateway)                 │
├─────────────────────────────────────────────────────────────┤
│                    应用服务层 (Spring Boot)                   │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────┐ │
│  │  用户管理    │ │  文档管理    │ │  向量处理    │ │ 问答服务 │ │
│  │   模块      │ │   模块      │ │   模块      │ │  模块   │ │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────┘ │
├─────────────────────────────────────────────────────────────┤
│                    业务逻辑层 (Service Layer)                 │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────┐ │
│  │ 用户服务     │ │ 文档服务     │ │ 向量服务     │ │ AI服务  │ │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────┘ │
├─────────────────────────────────────────────────────────────┤
│                    数据访问层 (DAO Layer)                     │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────┐ │
│  │ MySQL DAO   │ │ Milvus DAO  │ │ Redis DAO   │ │ OSS DAO │ │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────┘ │
├─────────────────────────────────────────────────────────────┤
│                    基础设施层 (Infrastructure)                │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────┐ │
│  │   MySQL     │ │   Milvus    │ │    Redis    │ │阿里云OSS │ │
│  │  (业务数据)  │ │  (向量数据)  │ │   (缓存)    │ │(文件存储)│ │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 架构特点
- **分层解耦**：清晰的分层架构，各层职责明确，便于维护和扩展
- **微服务化**：模块化设计，支持独立部署和扩展
- **异步处理**：文档处理和向量化采用异步处理机制
- **缓存优化**：多级缓存策略提升系统性能
- **高可用性**：支持集群部署和故障转移

## 2. 技术栈选型

### 2.1 后端技术栈

| 技术组件 | 版本 | 选型理由 |
|---------|------|----------|
| Spring Boot | 3.4.2 | 成熟的Java微服务框架，生态完善，开发效率高 |
| Spring AI | 1.0.0 | Spring官方AI框架，与Spring生态无缝集成 |
| Spring AI Alibaba | 1.0.0.1 | 阿里云AI服务集成，支持通义千问等模型 |
| JDK | 17 | 长期支持版本，性能优化，现代Java特性 |
| Maven | 3.9.9 | 成熟的项目构建和依赖管理工具 |
| MyBatis Plus | 3.5.10.1 | 增强的ORM框架，简化数据库操作 |
| Druid | 1.2.3 | 高性能数据库连接池，提供监控功能 |

### 2.2 数据存储技术栈

| 技术组件 | 版本 | 选型理由 |
|---------|------|----------|
| Milvus | 2.5+ | 专业向量数据库，高性能向量检索，支持多种索引 |
| MySQL | 8.0+ | 成熟的关系型数据库，存储业务数据 |
| Redis | 6.0+ | 高性能缓存数据库，提升系统响应速度 |
| 阿里云OSS | - | 对象存储服务，存储文档文件，成本低廉 |

### 2.3 AI和机器学习技术栈

| 技术组件 | 版本 | 选型理由 |
|---------|------|----------|
| 通义千问 | - | 阿里云大语言模型，中文支持好，API稳定 |
| Apache Tika | - | 文档解析库，支持多种文档格式 |
| IK Analyzer | 8.5.0 | 中文分词器，提升中文文本处理效果 |

### 2.4 开发和运维工具

| 技术组件 | 版本 | 选型理由 |
|---------|------|----------|
| Docker | - | 容器化部署，环境一致性，便于运维 |
| Docker Compose | - | 多容器编排，简化本地开发环境搭建 |
| Lombok | 1.18.40 | 减少样板代码，提升开发效率 |
| Hutool | 5.8.25 | Java工具类库，简化常用操作 |
| Fastjson2 | 2.0.33 | 高性能JSON处理库 |

## 3. 核心模块设计

### 3.1 用户管理模块

#### 3.1.1 模块职责
- 用户注册、登录、注销功能
- JWT令牌生成和验证
- 用户权限管理和角色控制
- 用户信息维护和更新

#### 3.1.2 核心组件
- **UserController**：用户相关API接口
- **UserService**：用户业务逻辑处理
- **JwtUtil**：JWT令牌工具类
- **AuthInterceptor**：认证拦截器

#### 3.1.3 交互逻辑
```
用户请求 → 认证拦截器 → JWT验证 → 权限检查 → 业务处理 → 响应返回
```

### 3.2 文档管理模块

#### 3.2.1 模块职责
- 文档上传和存储管理
- 多格式文档解析和预处理
- 文档元数据管理
- 文档删除和更新操作

#### 3.2.2 核心组件
- **DocumentController**：文档管理API接口
- **DocumentService**：文档业务逻辑处理
- **FileParserService**：文档解析服务
- **OssService**：对象存储服务

#### 3.2.3 交互逻辑
```
文档上传 → 格式验证 → OSS存储 → 文档解析 → 元数据保存 → 异步向量化
```

### 3.3 向量处理模块

#### 3.3.1 模块职责
- 文本向量化处理
- 向量数据存储和索引
- 向量相似度检索
- 向量数据管理和维护

#### 3.3.2 核心组件
- **VectorController**：向量管理API接口
- **VectorService**：向量业务逻辑处理
- **EmbeddingService**：文本向量化服务
- **MilvusService**：Milvus数据库操作服务

#### 3.3.3 交互逻辑
```
文本输入 → 预处理 → 向量化 → Milvus存储 → 索引构建 → 检索优化
```

### 3.4 智能问答模块

#### 3.4.1 模块职责
- 用户问题理解和处理
- 向量检索和相关内容获取
- 大语言模型调用和答案生成
- 对话历史管理和上下文维护

#### 3.4.2 核心组件
- **ChatController**：问答API接口
- **ChatService**：问答业务逻辑处理
- **RetrievalService**：检索服务
- **LLMService**：大语言模型服务

#### 3.4.3 交互逻辑
```
用户问题 → 问题向量化 → 向量检索 → 上下文构建 → LLM生成 → 答案返回
```

## 4. 数据流向设计

### 4.1 文档处理数据流
```
文档上传 → OSS存储 → 异步队列 → 文档解析 → 文本分段 → 向量化 → Milvus存储
    ↓
元数据提取 → MySQL存储 → 索引更新 → 处理状态更新
```

### 4.2 问答处理数据流
```
用户问题 → 问题预处理 → 向量化 → Milvus检索 → 相关文档片段
    ↓
上下文构建 → LLM调用 → 答案生成 → 结果缓存 → 用户响应
    ↓
对话历史 → Redis缓存 → MySQL持久化
```

### 4.3 用户认证数据流
```
登录请求 → 用户验证 → JWT生成 → Token返回
    ↓
后续请求 → Token验证 → 权限检查 → 业务处理
```

## 5. 依赖关系说明

### 5.1 模块间依赖关系
```
┌─────────────┐    ┌─────────────┐
│  用户管理    │    │  文档管理    │
│   模块      │    │   模块      │
└─────┬───────┘    └─────┬───────┘
      │                  │
      │                  ▼
      │            ┌─────────────┐
      │            │  向量处理    │
      │            │   模块      │
      │            └─────┬───────┘
      │                  │
      │                  ▼
      └─────────────► ┌─────────────┐
                     │  问答服务    │
                     │   模块      │
                     └─────────────┘
```

### 5.2 外部服务依赖
- **阿里云通义千问**：大语言模型服务，提供文本生成能力
- **阿里云OSS**：对象存储服务，存储文档文件
- **Milvus集群**：向量数据库服务，提供向量存储和检索
- **Redis集群**：缓存服务，提升系统性能
- **MySQL主从**：关系型数据库，存储业务数据

### 5.3 内部组件依赖
- **Controller层**：依赖Service层提供业务逻辑
- **Service层**：依赖DAO层进行数据访问
- **DAO层**：依赖具体的数据存储实现
- **工具类**：被各层组件调用，提供通用功能

## 6. 安全架构设计

### 6.1 认证授权机制
- **JWT认证**：无状态的令牌认证机制
- **角色权限**：基于RBAC的权限控制模型
- **接口鉴权**：细粒度的API访问控制

### 6.2 数据安全保护
- **传输加密**：HTTPS协议保护数据传输
- **存储加密**：敏感数据加密存储
- **访问控制**：数据库访问权限控制

### 6.3 系统安全防护
- **输入验证**：严格的参数校验和过滤
- **SQL注入防护**：使用参数化查询
- **XSS防护**：输出内容转义处理
- **CSRF防护**：跨站请求伪造防护

## 7. 性能优化设计

### 7.1 缓存策略
- **多级缓存**：本地缓存 + Redis分布式缓存
- **缓存预热**：系统启动时预加载热点数据
- **缓存更新**：基于事件的缓存失效机制

### 7.2 数据库优化
- **读写分离**：MySQL主从架构，读写分离
- **连接池优化**：Druid连接池参数调优
- **索引优化**：合理的数据库索引设计

### 7.3 向量检索优化
- **索引选择**：根据数据特点选择合适的向量索引
- **批量处理**：向量化和检索的批量操作
- **结果缓存**：检索结果的智能缓存

## 8. 扩展性设计

### 8.1 水平扩展能力
- **无状态设计**：应用服务无状态，支持多实例部署
- **负载均衡**：支持多种负载均衡策略
- **数据库分片**：支持数据库水平分片扩展

### 8.2 功能扩展能力
- **插件机制**：支持自定义文档处理插件
- **模型扩展**：支持多种大语言模型接入
- **存储扩展**：支持多种向量数据库后端

### 8.3 配置管理
- **外部化配置**：配置文件外部化管理
- **环境隔离**：支持多环境配置管理
- **动态配置**：支持运行时配置更新