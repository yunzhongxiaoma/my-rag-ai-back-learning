<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kinghy.rag.mapper.ChatMessageMapper">

    <resultMap id="BaseResultMap" type="com.kinghy.rag.entity.ChatMessage">
        <id property="id" column="id" />
        <result property="sessionId" column="session_id" />
        <result property="userId" column="user_id" />
        <result property="messageType" column="message_type" />
        <result property="content" column="content" />
        <result property="metadata" column="metadata" />
        <result property="createTime" column="create_time" />
    </resultMap>

    <sql id="Base_Column_List">
        id, session_id, user_id, message_type, content, metadata, create_time
    </sql>

    <!-- 获取会话的所有消息（按时间顺序） -->
    <select id="getSessionMessages" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM chat_message 
        WHERE session_id = #{sessionId} AND user_id = #{userId} 
        ORDER BY create_time ASC
    </select>

    <!-- 获取会话消息（分页，按时间顺序） -->
    <select id="getSessionMessagesPaged" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM chat_message 
        WHERE session_id = #{sessionId} AND user_id = #{userId} 
        ORDER BY create_time ASC 
        LIMIT #{offset}, #{size}
    </select>

    <!-- 获取会话最近的消息（按时间倒序） -->
    <select id="getRecentMessages" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM chat_message 
        WHERE session_id = #{sessionId} AND user_id = #{userId} 
        ORDER BY create_time DESC 
        LIMIT #{limit}
    </select>

    <!-- 获取会话消息数量 -->
    <select id="getMessageCount" resultType="long">
        SELECT COUNT(*) 
        FROM chat_message 
        WHERE session_id = #{sessionId} AND user_id = #{userId}
    </select>

    <!-- 获取用户在会话中的最后一条消息 -->
    <select id="getLastMessage" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM chat_message 
        WHERE session_id = #{sessionId} AND user_id = #{userId} 
        ORDER BY create_time DESC 
        LIMIT 1
    </select>

    <!-- 获取会话中的第一条用户消息（用于生成会话标题） -->
    <select id="getFirstUserMessage" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM chat_message 
        WHERE session_id = #{sessionId} AND message_type = 'USER' 
        ORDER BY create_time ASC 
        LIMIT 1
    </select>

    <!-- 根据用户ID获取所有消息（用于数据导出等场景） -->
    <select id="getAllUserMessages" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM chat_message 
        WHERE user_id = #{userId} 
        ORDER BY create_time DESC 
        LIMIT #{offset}, #{size}
    </select>

    <!-- 删除会话的所有消息 -->
    <delete id="deleteSessionMessages">
        DELETE FROM chat_message 
        WHERE session_id = #{sessionId} AND user_id = #{userId}
    </delete>

    <!-- 批量插入消息 -->
    <insert id="batchInsert" parameterType="java.util.List">
        INSERT INTO chat_message (session_id, user_id, message_type, content, metadata, create_time)
        VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.sessionId}, #{item.userId}, #{item.messageType}, #{item.content}, 
             #{item.metadata}, #{item.createTime})
        </foreach>
    </insert>

    <!-- 根据条件查询消息 -->
    <select id="selectByCondition" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM chat_message
        <where>
            <if test="sessionId != null and sessionId != ''">
                AND session_id = #{sessionId}
            </if>
            <if test="userId != null">
                AND user_id = #{userId}
            </if>
            <if test="messageType != null">
                AND message_type = #{messageType}
            </if>
            <if test="content != null and content != ''">
                AND content LIKE CONCAT('%', #{content}, '%')
            </if>
            <if test="startTime != null">
                AND create_time >= #{startTime}
            </if>
            <if test="endTime != null">
                AND create_time &lt;= #{endTime}
            </if>
        </where>
        ORDER BY create_time ASC
    </select>

    <!-- 获取用户消息统计 -->
    <select id="getUserMessageStats" resultType="java.util.Map">
        SELECT 
            COUNT(*) as total_messages,
            COUNT(CASE WHEN message_type = 'USER' THEN 1 END) as user_messages,
            COUNT(CASE WHEN message_type = 'ASSISTANT' THEN 1 END) as assistant_messages,
            MIN(create_time) as first_message_time,
            MAX(create_time) as last_message_time
        FROM chat_message 
        WHERE user_id = #{userId}
        <if test="sessionId != null and sessionId != ''">
            AND session_id = #{sessionId}
        </if>
    </select>

    <!-- 删除用户的所有消息 -->
    <delete id="deleteUserMessages">
        DELETE FROM chat_message 
        WHERE user_id = #{userId}
    </delete>

    <!-- 清理过期消息 -->
    <delete id="cleanupExpiredMessages">
        DELETE FROM chat_message 
        WHERE create_time &lt; #{expireTime}
    </delete>

    <!-- 获取会话消息摘要（用于会话列表显示） -->
    <select id="getSessionMessageSummary" resultType="java.util.Map">
        SELECT 
            COUNT(*) as message_count,
            MAX(create_time) as last_message_time,
            (SELECT content FROM chat_message 
             WHERE session_id = #{sessionId} AND message_type = 'USER' 
             ORDER BY create_time ASC LIMIT 1) as first_user_message
        FROM chat_message 
        WHERE session_id = #{sessionId}
    </select>

    <!-- 搜索消息内容 -->
    <select id="searchMessages" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM chat_message
        WHERE user_id = #{userId}
        AND content LIKE CONCAT('%', #{keyword}, '%')
        <if test="sessionId != null and sessionId != ''">
            AND session_id = #{sessionId}
        </if>
        ORDER BY create_time DESC
        LIMIT #{offset}, #{size}
    </select>

    <!-- 获取会话消息（游标分页） -->
    <select id="getSessionMessagesByCursor" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM chat_message 
        WHERE session_id = #{sessionId} AND user_id = #{userId}
        <if test="cursor != null and cursor != ''">
            AND (create_time &gt; (SELECT create_time FROM chat_message WHERE id = #{cursor})
                 OR (create_time = (SELECT create_time FROM chat_message WHERE id = #{cursor})
                     AND id &gt; #{cursor}))
        </if>
        ORDER BY create_time ASC, id ASC 
        LIMIT #{size}
    </select>

</mapper>